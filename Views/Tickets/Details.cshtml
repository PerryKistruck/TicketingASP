@using TicketingASP.Models.DTOs
@model TicketDetailDto
@{
    ViewData["Title"] = $"Ticket {Model.TicketNumber}";
    var lookups = ViewBag.Lookups as TicketFormLookupsDto;
    
    // Helper function to determine if text should be dark based on background color luminance
    string GetTextColor(string? hexColor)
    {
        if (string.IsNullOrEmpty(hexColor)) return "#000000";
        var hex = hexColor.TrimStart('#');
        if (hex.Length < 6) return "#000000";
        var r = Convert.ToInt32(hex.Substring(0, 2), 16);
        var g = Convert.ToInt32(hex.Substring(2, 2), 16);
        var b = Convert.ToInt32(hex.Substring(4, 2), 16);
        // Calculate relative luminance
        var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? "#000000" : "#FFFFFF";
    }
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-start">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index")">Tickets</a></li>
                        <li class="breadcrumb-item active">@Model.TicketNumber</li>
                    </ol>
                </nav>
                <h1 class="h3">@Model.Title</h1>
                <div class="d-flex gap-2 mt-2">
                    <span class="badge fs-6" style="background-color: @Model.StatusColour; color: @GetTextColor(Model.StatusColour)">@Model.StatusName</span>
                    <span class="badge fs-6" style="background-color: @Model.PriorityColour; color: @GetTextColor(Model.PriorityColour)">@Model.PriorityName</span>
                    <span class="badge bg-secondary fs-6">@Model.CategoryName</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-outline-primary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <form method="post" asp-action="Delete" asp-route-id="@Model.Id" onsubmit="return confirm('Are you sure you want to delete this ticket?');" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Description</h5>
                </div>
                <div class="card-body">
                    <div class="ticket-description">
                        @Html.Raw(Model.Description?.Replace("\n", "<br>") ?? "<em class=\"text-muted\">No description provided</em>")
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Comments (@(Model.Comments?.Count ?? 0))</h5>
                </div>
                <div class="card-body">
                    @if (Model.Comments?.Any() == true)
                    {
                        @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                        {
                            <div class="mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>@comment.AuthorName</strong>
                                        @if (comment.IsInternal)
                                        {
                                            <span class="badge bg-warning text-dark ms-2">Internal</span>
                                        }
                                    </div>
                                    <small class="text-muted">@comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                                </div>
                                <p class="mb-0">@Html.Raw(comment.Content.Replace("\n", "<br>"))</p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No comments yet.</p>
                    }
                </div>
                <div class="card-footer">
                    <form method="post" asp-action="AddComment" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <textarea class="form-control" name="content" rows="3" placeholder="Add a comment..." required></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isInternal" id="isInternal" value="true">
                                <label class="form-check-label" for="isInternal">Internal note (not visible to requester)</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Comment</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">History (@(Model.History?.Count ?? 0))</h5>
                </div>
                <div class="card-body">
                    @if (Model.History?.Any() == true)
                    {
                        <div class="timeline">
                            @foreach (var entry in Model.History.OrderByDescending(h => h.ChangedAt))
                            {
                                <div class="mb-3 pb-3 border-bottom">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>@entry.ChangedByName</strong> changed <em>@entry.FieldName</em>
                                        </div>
                                        <small class="text-muted">@entry.ChangedAt.ToString("MMM dd, yyyy HH:mm")</small>
                                    </div>
                                    <div class="text-muted mt-1">
                                        <span class="text-danger">@(entry.OldValue ?? "(none)")</span>
                                        <i class="bi bi-arrow-right mx-2"></i>
                                        <span class="text-success">@(entry.NewValue ?? "(none)")</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No history available.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Ticket Number</dt>
                        <dd class="col-sm-7">@Model.TicketNumber</dd>

                        <dt class="col-sm-5">Created By</dt>
                        <dd class="col-sm-7">@Model.CreatedByName</dd>

                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">@Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</dd>

                        <dt class="col-sm-5">Assigned To</dt>
                        <dd class="col-sm-7">
                            @if (!string.IsNullOrEmpty(Model.AssignedToName))
                            {
                                @Model.AssignedToName
                            }
                            else
                            {
                                <em class="text-muted">Unassigned</em>
                            }
                        </dd>

                        <dt class="col-sm-5">Team</dt>
                        <dd class="col-sm-7">
                            @if (!string.IsNullOrEmpty(Model.AssignedTeamName))
                            {
                                @Model.AssignedTeamName
                            }
                            else
                            {
                                <em class="text-muted">None</em>
                            }
                        </dd>

                        <dt class="col-sm-5">Due Date</dt>
                        <dd class="col-sm-7">
                            @if (Model.DueDate.HasValue)
                            {
                                var isOverdue = Model.DueDate < DateTime.UtcNow;
                                <span class="@(isOverdue ? "text-danger fw-bold" : "")">
                                    @Model.DueDate.Value.ToString("MMM dd, yyyy HH:mm")
                                </span>
                                @if (isOverdue)
                                {
                                    <span class="badge bg-danger ms-1">Overdue</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Not set</span>
                            }
                        </dd>

                        @if (Model.ResolvedAt.HasValue)
                        {
                            <dt class="col-sm-5">Resolved</dt>
                            <dd class="col-sm-7">@Model.ResolvedAt.Value.ToString("MMM dd, yyyy HH:mm")</dd>
                        }

                        @if (Model.ClosedAt.HasValue)
                        {
                            <dt class="col-sm-5">Closed</dt>
                            <dd class="col-sm-7">@Model.ClosedAt.Value.ToString("MMM dd, yyyy HH:mm")</dd>
                        }

                        @if (!string.IsNullOrEmpty(Model.Tags))
                        {
                            <dt class="col-sm-5">Tags</dt>
                            <dd class="col-sm-7">
                                @foreach (var tag in Model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="badge bg-info me-1">@tag.Trim()</span>
                                }
                            </dd>
                        }
                    </dl>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <!-- Status Change -->
                    <div class="mb-3">
                        <label class="form-label">Change Status</label>
                        <select class="form-select" id="statusSelect" onchange="changeStatus(this.value)">
                            <option value="">Select status...</option>
                            @if (lookups?.Statuses != null)
                            {
                                @foreach (var status in lookups.Statuses)
                                {
                                    <option value="@status.Id" selected="@(Model.StatusId == status.Id)">@status.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Assignment -->
                    <div class="mb-3">
                        <label class="form-label">Assign To Team</label>
                        <select class="form-select" id="teamSelect" onchange="assignTeam(this.value)">
                            <option value="">Select team...</option>
                            @if (lookups?.Teams != null)
                            {
                                @foreach (var team in lookups.Teams)
                                {
                                    <option value="@team.Id" selected="@(Model.AssignedTeamId == team.Id)">@team.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Assign To Agent</label>
                        <select class="form-select" id="agentSelect" onchange="assignAgent(this.value)">
                            <option value="">Select agent...</option>
                            @if (lookups?.Agents != null)
                            {
                                @foreach (var agent in lookups.Agents)
                                {
                                    <option value="@agent.Id" selected="@(Model.AssignedToId == agent.Id)">@agent.Name</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const ticketId = @Model.Id;

        function changeStatus(statusId) {
            if (!statusId) return;
            fetch('@Url.Action("ChangeStatus")/' + ticketId + '?statusId=' + statusId, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to change status');
                }
            });
        }

        function assignTeam(teamId) {
            // Preserve current agent when changing team
            // Use 0 to indicate "unassign", empty/null means "keep current"
            const currentAgentId = document.getElementById('agentSelect').value;
            let url = '@Url.Action("Assign")/' + ticketId + '?assignedTeamId=' + (teamId || '0');
            if (currentAgentId) {
                url += '&assignedToId=' + currentAgentId;
            }
            fetch(url, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to assign team');
                }
            });
        }

        function assignAgent(agentId) {
            // Preserve current team when changing agent
            // Use 0 to indicate "unassign", empty/null means "keep current"
            const currentTeamId = document.getElementById('teamSelect').value;
            let url = '@Url.Action("Assign")/' + ticketId + '?assignedToId=' + (agentId || '0');
            if (currentTeamId) {
                url += '&assignedTeamId=' + currentTeamId;
            }
            fetch(url, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to assign agent');
                }
            });
        }
    </script>
}
